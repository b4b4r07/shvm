#!/bin/sh

if [ "$_" = "$0" ]; then
  cat << EOS
shvm-init must be sourced from shell, instead of executable command.
Add the following line to $HOME/.bash_profile, and restart your shell.

  source $SHVM_HOME/bin/shvm-init

EOS
  exit 1
fi

shvm_save_config() {
  echo "export SHVM_DEFAULT_VERSION=${SHVM_DEFAULT_VERSION}" \
    >"$SHVM_HOME/config"

}
export -f shvm_save_config

shvm_use() {
  install=
  default=
  target=

  while test $# != 0; do
    case "$1" in
    --help)
      "$SHVM_HOME/usr/shvm-core/shvm-use" --help
      return 0
      ;;
    --install)
      install=t
      ;;
    --default)
      default=t
      ;;
    -*|--*)
      echo "Unrecognized option: $1" >&2
      return 1
      ;;
    *)
      target="$1"
      ;;
    esac
    shift
  done

  if [ -z "$target" ]; then
    "$SHVM_HOME/usr/shvm-core/shvm-use" --help
    return 1
  fi

  [ -n "$install" ] && "$SHVM_HOME/usr/shvm-core/shvm-install" "$target"

  if ! [ -d "$SHVM_HOME/usr/$target" ] || [ "$target" = 'system' ]; then
    echo "Unknown bash version: $target." >&2
    return 1
  fi

  if [ -n "$default" ]; then
    SHVM_DEFAULT_VERSION="$target"
    shvm_save_config
  fi

  if [ "$target" = 'system' ]; then
    export PATH="$shvm_original_path"
  else
    export PATH="$SHVM_HOME/usr/$target/bin:$shvm_original_path"
  fi

  echo "Switched to $target"
}
export -f shvm_use

shvm() {
  case "$1" in
  list)
    shift
    "$SHVM_HOME/usr/shvm-core/shvm-list" "$@"
    ;;
  use)
    shift
    shvm_use "$@"
    ;;
  fetch)
    shift
    "$SHVM_HOME/usr/shvm-core/shvm-fetch" "$@"
    ;;
  install)
    shift
    "$SHVM_HOME/usr/shvm-core/shvm-install" "$@"
    ;;
  uninstall)
    shift
    "$SHVM_HOME/usr/shvm-core/shvm-uninstall" "$@"
    ;;
  help)
    shift
    "$SHVM_HOME/usr/shvm-core/shvm-help" "$@"
    ;;
  --help)
    shift
    "$SHVM_HOME/usr/shvm-core/shvm-help"
    ;;
  --version)
    shift
    echo "shvm version 0.0.0"
    ;;
  -*|--*)
    echo "Unrecognized option: $1" >&2
    return 1
    ;;
  *)
    echo "Unrecognized command: $1" >&2
    return 1
    ;;
  esac
}
export -f shvm

export SHVM_HOME=${SHVM_HOME:-$HOME/.shvm}
PATH="$SHVM_HOME/bin:$PATH"

# shellcheck disable=SC1090
test -f "$SHVM_HOME/config" && . "$SHVM_HOME/config"
export SHVM_DEFAULT_VERSION=${SHVM_DEFAULT_VERSION:-system}
shvm_save_config

shvm_original_path="$PATH"

shvm use "$SHVM_DEFAULT_VERSION" >/dev/null
