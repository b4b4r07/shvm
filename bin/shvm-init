#!/usr/bin/env bash

if [[ $_ == $0 ]]; then
  cat << EOS
shvm-init must be sourced from shell, instead of executable command.
Add the following line to $HOME/.bash_profile, and restart your shell.

  source $SHVM_HOME/bin/shvm-init

EOS
  exit 1
fi

shvm_die() {
  echo "$@" >&2
  exit 1
}
export -f shvm_die

shvm_save_config() {
  declare -p SHVM_DEFAULT_VERSION >$SHVM_HOME/config
}
export -f shvm_save_config

shvm_use() {
  local install=
  local default=
  local bash_version=

  while test $# != 0; do
    case "$1" in
    --help)
      shvm-use --help
      return 0
      ;;
    --install)
      install=t
      ;;
    --default)
      default=t
      ;;
    -*|--*)
      echo "Unrecognized option: $1" >&2
      return 1
      ;;
    *)
      bash_version="${1#bash-}"
      ;;
    esac
    shift
  done

  if [ -z "$bash_version" ]; then
    shvm-use --help
    return 1
  fi

  [[ -n "$install" ]] && shvm-install "$bash_version"

  if ! [[ -d "$SHVM_HOME/usr/bash-${bash_version}" || ${bash_version} = 'system' ]]; then
    echo "Unknown bash version: bash-${bash_version}." >&2
    return 1
  fi

  if [[ -n "$default" ]]; then
    SHVM_DEFAULT_VERSION=$bash_version
    shvm_save_config
  fi

  if [[ $bash_version = 'system' ]]; then
    export PATH=$shvm_original_path
  else
    export PATH="$SHVM_HOME/usr/bash-${bash_version}/bin:$shvm_original_path"
  fi

  echo "Switched to bash-${bash_version}"
}
export -f shvm_use

shvm() {
  case "$1" in
  list)
    shift
    shvm-list "$@"
    ;;
  use)
    shift
    shvm_use "$@"
    ;;
  fetch)
    shift
    shvm-fetch "$@"
    ;;
  install)
    shift
    shvm-install "$@"
    ;;
  uninstall)
    shift
    shvm-uninstall "$@"
    ;;
  help)
    shift
    shvm-help "$@"
    ;;
  --help)
    shift
    shvm-help
    ;;
  --version)
    shift
    echo "shvm version 0.0.0"
    ;;
  -*|--*)
    echo "Unrecognized option: $1" >&2
    return 1
    ;;
  *)
    echo "Unrecognized command: $1" >&2
    return 1
    ;;
  esac
}
export -f shvm

export SHVM_HOME=${SHVM_HOME:-$HOME/.shvm}
PATH="$(readlink -f $(dirname $BASH_SOURCE)):$PATH"

test -f $SHVM_HOME/config && source $SHVM_HOME/config
export SHVM_DEFAULT_VERSION=${SHVM_DEFAULT_VERSION:-system}
shvm_save_config

shvm_original_path=$PATH

shvm use $SHVM_DEFAULT_VERSION >/dev/null
